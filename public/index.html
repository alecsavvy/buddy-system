<!doctype html>
<html>
<head>
<script src="/socket.io/socket.io.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<title>496 Project</title>
</head>
<body>
    <div id="server-time">Welcome!</div>
    <div>
        <div id="client-id">No id yet!</div>
        <div id="client-coords">No latitude yet!</div>
    </div>
</body>
<script>
        var socket = io();
        var el = document.getElementById('server-time');
        var currentLocation = "cannot find location";
        var clientid = null;

        socket.on('user', function(userid){
            clientid = userid;
            document.getElementById('client-id').innerHTML = userid;
        });
        socket.on('time', function(timeString){
            if (!timeString){
                el.innerHTML = 'Server time: Loading...';
            } else {
                el.innerHTML = 'Server time: ' + timeString;
            }
        });

        socket.on('disconnect', () => {
            socket.emit('del_user', clientid);
        });

        function getLocation(){
                jQuery.post( "https://www.googleapis.com/geolocation/v1/geolocate?key=AIzaSyBQVO1VBB3f_XRhuuSGVi8kaFFkRRognpc", function(position)
                {
                    pos = position.location;

                    document.getElementById('client-coords').innerHTML = "Latitude: " + pos.lat + 
                            "<br>Longitude: " + pos.lng; 

                    var currentLocation = {
                        id: clientid,
                        lat: pos.lat,
                        lng: pos.lng
                    }
                    socket.emit('loc', currentLocation);
                }
            )
                .fail(function(err) {
                alert("API Geolocation error! \n\n"+err);
        });
};
        window.onbeforeunload = onDisconnect;
        function onDisconnect(){
            socket.emit('del_user', clientid);
        }

        window.addEventListener("pagehide", onDisconnect, false);

        setInterval(getLocation, 10000);
    </script>
</html>